<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Product Management - ScentSational Admin</title>
        <link rel="stylesheet" href="admin.css">
    </head>
    <body>
        <header class="main-header">
            <div class="logo-container">
                <img src="../frontend/src/assets/images/scentsational-logo.png" alt="Logo">
            </div>
            <nav class="main-nav">
                <a href="/admin/dashboard">Dashboard</a>
                <a href="/admin/products">Product Management</a>
                <a href="/admin/orders">Orders</a>
                <a href="/admin/categories">Categories</a>
            </nav>
        </header>

        <main class="content-wrapper">
            <div class="page-header">
                <h2>Products</h2>
                <button class="btn-add-new">+ Add New Product</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>IMAGE</th>
                            <th>NAME</th>
                            <th>CATEGORY</th>
                            <th>PRICE</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body">
                    </tbody>
                </table>
            </div>
            <!-- Pagination Controls -->
            <div class="pagination-controls">
                <button id="prev-page-btn">&laquo; Previous</button>
                <span id="page-info"></span>
                <button id="next-page-btn">Next &raquo;</button>
            </div>
        </main>

        <div id="product-modal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h2 id="modal-title">Add New Product</h2>
                <form id="product-form">
                    <input type="hidden" id="product-id">
                    <label for="name">Product Name:</label>
                    <input type="text" id="name" name="name" required>

                    <label for="price">Price:</label>
                    <input type="number" id="price" name="price" required>
                    
                    <label for="category">Category:</label>
                    <select id="category" name="category" required></select>

                    <label for="image">Product Image:</label>
                    <input type="file" id="image" name="image">
                    
                    <button type="submit" class="btn-submit">Save Product</button>
                </form>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const tableBody = document.getElementById('products-table-body');
                const modal = document.getElementById('product-modal');
                const addBtn = document.querySelector('.btn-add-new');
                const closeBtn = modal.querySelector('.close-button');
                const productForm = document.getElementById('product-form');
                const categorySelect = document.getElementById('category');
                const modalTitle = document.getElementById('modal-title');
                const productIdInput = document.getElementById('product-id');
                const prevPageBtn = document.getElementById('prev-page-btn');
                const nextPageBtn = document.getElementById('next-page-btn');
                const pageInfo = document.getElementById('page-info');

                let allProducts = [];
                let currentPage = 1;
                const itemsPerPage = 5; // You can adjust this number

                const apiBase = '/api/products';

                const displayProducts = () => {
                    tableBody.innerHTML = '';
                    const startIndex = (currentPage - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const paginatedProducts = allProducts.slice(startIndex, endIndex);

                    paginatedProducts.forEach(product => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img src="${product.imageUrl}" alt="${product.name}" class="product-thumb"></td>
                            <td>${product.name}</td>
                            <td>${product.category ? product.category.name : 'N/A'}</td>
                            <td>${product.price}</td>
                            <td>
                                <button class="btn-edit" data-id="${product._id}">EDIT</button>
                                <button class="btn-delete" data-id="${product._id}">DELETE</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    updatePagination();
                };

                const updatePagination = () => {
                    const totalPages = Math.ceil(allProducts.length / itemsPerPage);
                    pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
                    prevPageBtn.disabled = currentPage === 1;
                    nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
                };

                const fetchProducts = async () => {
                    try {
                        const response = await fetch(apiBase);
                        allProducts = await response.json();
                        currentPage = 1; // Reset to first page
                        displayProducts();
                    } catch (error) {
                        console.error('Error fetching products:', error);
                    }
                };
                
                const fetchCategories = async () => {
                    const response = await fetch('/api/categories');
                    const categories = await response.json();
                    categorySelect.innerHTML = '<option value="">-- Select a Category --</option>';
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat._id;
                        option.textContent = cat.name;
                        categorySelect.appendChild(option);
                    });
                };

                const openModal = (mode = 'add', product = null) => {
                    productForm.reset();
                    fetchCategories().then(() => {
                        if (mode === 'edit' && product) {
                            modalTitle.textContent = 'Edit Product';
                            productIdInput.value = product._id;
                            productForm.name.value = product.name;
                            productForm.price.value = product.price;
                            if (product.category) {
                                productForm.category.value = product.category._id;
                            }
                            productForm.image.required = false;
                        } else {
                            modalTitle.textContent = 'Add New Product';
                            productIdInput.value = '';
                            productForm.image.required = true;
                        }
                        modal.style.display = 'flex';
                    });
                };

                const closeModal = () => {
                    modal.style.display = 'none';
                };

                addBtn.onclick = () => openModal('add');
                closeBtn.onclick = closeModal;

                productForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const id = productIdInput.value;
                    const isEditing = !!id;

                    let imageUrl;
                    const imageFile = productForm.image.files[0];

                    if (imageFile) {
                        const uploadFormData = new FormData();
                        uploadFormData.append('image', imageFile);

                        const uploadResponse = await fetch('/api/upload', {
                            method: 'POST',
                            body: uploadFormData,
                        });
                        const uploadData = await uploadResponse.json();
                        imageUrl = uploadData.filePath;
                    }

                    const productData = {
                        name: productForm.name.value,
                        price: productForm.price.value,
                        category: productForm.category.value,
                    };

                    if (imageUrl) {
                        productData.imageUrl = imageUrl;
                    }

                    const url = isEditing ? `${apiBase}/${id}` : apiBase;
                    const method = isEditing ? 'PUT' : 'POST';

                    await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData),
                    });
                    
                    closeModal();
                    fetchProducts();
                });
                
                tableBody.addEventListener('click', async (e) => {
                    const target = e.target;
                    const id = target.dataset.id;

                    if (target.classList.contains('btn-edit')) {
                        const productToEdit = allProducts.find(p => p._id === id);
                        if (productToEdit) {
                            openModal('edit', productToEdit);
                        }
                    }

                    if (target.classList.contains('btn-delete')) {
                        if (confirm('Are you sure you want to delete this product?')) {
                            await fetch(`${apiBase}/${id}`, { method: 'DELETE' });
                            fetchProducts();
                        }
                    }
                });

                prevPageBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        displayProducts();
                    }
                });

                nextPageBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(allProducts.length / itemsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        displayProducts();
                    }
                });
                
                fetchProducts();
            });
        </script>
    </body>
</html>

